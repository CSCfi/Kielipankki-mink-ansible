---

- name: Install packages
  ansible.builtin.dnf:
    name:
      - memcached
      - socat
      - sqlite
      - time

- name: Install systemd templates
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "/etc/systemd/system/{{ item }}"
  loop:
    - mink-backend.service
    - mink-backend.socket
    - mink-manager.service
    - socat.service

- name: Fetch repo
  ansible.builtin.git:
    repo: "{{ mink_backend_repo }}"
    version: "{{ mink_backend_version }}"
    dest: "{{ mink_backend_dir }}"
    umask: "0022"
  notify: restart mink-backend

- name: Install requirements
  ansible.builtin.pip:
    requirements: "{{ mink_backend_dir }}/requirements.txt"
    virtualenv: "{{ mink_backend_dir }}/venv"

- name: Create dirs
  ansible.builtin.file:
    state: directory
    path: "{{ mink_backend_dir }}/instance/logs"
    
- name: Install config
  ansible.builtin.template:
    src: config.py.j2
    dest: "{{ mink_backend_dir }}/instance/config.py"
  notify: restart mink-backend

- name: Install auth public key
  ansible.builtin.copy:
    src: public_key.pem
    dest: "{{ mink_backend_dir }}/instance/keys/public_key.pem"

- name: Generate SSH keys
  community.crypto.openssh_keypair:
    path: /root/.ssh/service_key
    type: rsa
    size: 2048

- name: Read public key
  ansible.builtin.slurp:
    src: /root/.ssh/service_key.pub
  register: public_ssh_key

- name: Install public key on Korp
  ansible.posix.authorized_key:
    user: almalinux
    key: "{{ public_ssh_key.content | b64decode | trim }}"
    comment: Mink installation key
  delegate_to: korp

- name: Enable ssh login locally and on Korp
  vars:
    korp_ip: "{{ (lookup('file', 'inventories/korp/hosts') | from_yaml)['all']['vars']['ip_address'] }}"
  ansible.common.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  loop:
    - src: "ssh_permit_root_login.conf"
      dest: "/etc/ssh/sshd_config.d/permit_root_login.conf"
    - src: ssh_config
      dest: "/root/.ssh/config"

- name: start services
  systemd:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop:
    - mink-backend
    - mink-manager
    - socat

